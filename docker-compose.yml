version: '3.8'

services:
  wkf-postgres:
    image: postgres:16-alpine
    container_name: wkf-postgres
    deploy:
      resources:
        limits:
          memory: 256M
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    networks:
      - wkf-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5

  wkf-scraper:
    build:
      context: ./scraper
      dockerfile: Dockerfile
    container_name: wkf-scraper
    environment:
      DB_HOST: wkf-postgres
      DB_PORT: ${DB_PORT}
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      TARGET_URL: ${TARGET_URL}
      SCRAPING_INTERVAL_SECONDS: ${SCRAPING_INTERVAL_SECONDS}
      LOG_LEVEL: ${LOG_LEVEL}
      LOG_FILE: ${LOG_FILE}
      MIN_DELAY_SECONDS: ${MIN_DELAY_SECONDS}
      MAX_DELAY_SECONDS: ${MAX_DELAY_SECONDS}
      MIN_REQUEST_INTERVAL: ${MIN_REQUEST_INTERVAL}
      REQUEST_TIMEOUT: ${REQUEST_TIMEOUT}
      MAX_RETRIES: ${MAX_RETRIES}
      PROXY_ENABLED: ${PROXY_ENABLED}
      PROXY_HTTP: ${PROXY_HTTP}
      PROXY_HTTPS: ${PROXY_HTTPS}
    volumes:
      - ./logs:/app/logs
    depends_on:
      wkf-postgres:
        condition: service_healthy
    networks:
      - wkf-network
    restart: always

  wkf-disclosure-scraper:
    build:
      context: .
      dockerfile: disclosure-scraper/Dockerfile
    container_name: wkf-disclosure-scraper
    deploy:
      resources:
        limits:
          memory: 128M
    environment:
      # Database
      DB_HOST: wkf-postgres
      DB_PORT: ${DB_PORT}
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}

      # OpenDART API
      OPENDART_API_KEY: ${OPENDART_API_KEY}
      OPENDART_BASE_URL: ${OPENDART_BASE_URL}

      # Scraping Configuration
      DISCLOSURE_SCRAPING_INTERVAL_SECONDS: ${DISCLOSURE_SCRAPING_INTERVAL_SECONDS}
      DISCLOSURE_CORP_CLS: ${DISCLOSURE_CORP_CLS}
      DISCLOSURE_PAGE_COUNT: ${DISCLOSURE_PAGE_COUNT}

      # Telegram
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN}
      TELEGRAM_CHAT_ID: ${TELEGRAM_CHAT_ID}

      # Logging
      LOG_LEVEL: ${LOG_LEVEL}
      LOG_FILE: logs/disclosure-scraper.log
    volumes:
      - ./logs:/app/logs
    depends_on:
      wkf-postgres:
        condition: service_healthy
    networks:
      - wkf-network
    restart: always

  wkf-analyzer-claude:
    build:
      context: .
      dockerfile: analyzer-claude/Dockerfile
    container_name: wkf-analyzer-claude
    deploy:
      resources:
        limits:
          memory: 192M
    environment:
      # Database
      DB_HOST: wkf-postgres
      DB_PORT: ${DB_PORT}
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}

      # Anthropic Claude
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      ANALYSIS_THRESHOLD_PERCENT: ${ANALYSIS_THRESHOLD_PERCENT}
      MAX_RECOMMENDATIONS_PER_ARTICLE: ${MAX_RECOMMENDATIONS_PER_ARTICLE}

      # KIS API
      KIS_APP_KEY: ${KIS_APP_KEY}
      KIS_APP_SECRET: ${KIS_APP_SECRET}
      KIS_ACCOUNT_NUMBER: ${KIS_ACCOUNT_NUMBER}
      KIS_BASE_URL: ${KIS_BASE_URL}
      KIS_IS_REAL_ACCOUNT: ${KIS_IS_REAL_ACCOUNT}

      # Market
      MARKET_OPEN_HOUR: ${MARKET_OPEN_HOUR}
      MARKET_OPEN_MINUTE: ${MARKET_OPEN_MINUTE}
      MARKET_CLOSE_HOUR: ${MARKET_CLOSE_HOUR}
      MARKET_CLOSE_MINUTE: ${MARKET_CLOSE_MINUTE}
      STOCK_HISTORY_DAYS: ${STOCK_HISTORY_DAYS}

      # Trading
      PROFIT_TARGET_PERCENT: ${PROFIT_TARGET_PERCENT}
      STOP_LOSS_PERCENT: ${STOP_LOSS_PERCENT}
      TRADE_MONITORING_INTERVAL_SECONDS: ${TRADE_MONITORING_INTERVAL_SECONDS}
      TRADE_AMOUNT_PER_STOCK: ${TRADE_AMOUNT_PER_STOCK}

      # Retry
      MAX_API_RETRIES: ${MAX_API_RETRIES}
      RETRY_BACKOFF_FACTOR: ${RETRY_BACKOFF_FACTOR}

      # Telegram
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN}
      TELEGRAM_CHAT_ID: ${TELEGRAM_CHAT_ID}

      # Logging
      LOG_LEVEL: ${LOG_LEVEL}
      LOG_FILE: logs/analyzer-claude.log
    volumes:
      - ./logs:/app/logs
    depends_on:
      wkf-postgres:
        condition: service_healthy
    networks:
      - wkf-network
    restart: always

  wkf-analyzer-gemini:
    build:
      context: .
      dockerfile: analyzer-gemini/Dockerfile
    container_name: wkf-analyzer-gemini
    deploy:
      resources:
        limits:
          memory: 192M
    environment:
      # Database
      DB_HOST: wkf-postgres
      DB_PORT: ${DB_PORT}
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}

      # Google Gemini
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      ANALYSIS_THRESHOLD_PERCENT: ${ANALYSIS_THRESHOLD_PERCENT}
      MAX_RECOMMENDATIONS_PER_ARTICLE: ${MAX_RECOMMENDATIONS_PER_ARTICLE}

      # KIS API
      KIS_APP_KEY: ${KIS_APP_KEY}
      KIS_APP_SECRET: ${KIS_APP_SECRET}
      KIS_ACCOUNT_NUMBER: ${KIS_ACCOUNT_NUMBER}
      KIS_BASE_URL: ${KIS_BASE_URL}
      KIS_IS_REAL_ACCOUNT: ${KIS_IS_REAL_ACCOUNT}

      # Market
      MARKET_OPEN_HOUR: ${MARKET_OPEN_HOUR}
      MARKET_OPEN_MINUTE: ${MARKET_OPEN_MINUTE}
      MARKET_CLOSE_HOUR: ${MARKET_CLOSE_HOUR}
      MARKET_CLOSE_MINUTE: ${MARKET_CLOSE_MINUTE}
      STOCK_HISTORY_DAYS: ${STOCK_HISTORY_DAYS}

      # Trading
      PROFIT_TARGET_PERCENT: ${PROFIT_TARGET_PERCENT}
      STOP_LOSS_PERCENT: ${STOP_LOSS_PERCENT}
      TRADE_MONITORING_INTERVAL_SECONDS: ${TRADE_MONITORING_INTERVAL_SECONDS}
      TRADE_AMOUNT_PER_STOCK: ${TRADE_AMOUNT_PER_STOCK}

      # Retry
      MAX_API_RETRIES: ${MAX_API_RETRIES}
      RETRY_BACKOFF_FACTOR: ${RETRY_BACKOFF_FACTOR}

      # Telegram
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN}
      TELEGRAM_CHAT_ID: ${TELEGRAM_CHAT_ID}

      # Logging
      LOG_LEVEL: ${LOG_LEVEL}
      LOG_FILE: logs/analyzer-gemini.log
    volumes:
      - ./logs:/app/logs
    depends_on:
      wkf-postgres:
        condition: service_healthy
    networks:
      - wkf-network
    restart: always

  wkf-analyzer-openai:
    build:
      context: .
      dockerfile: analyzer-openai/Dockerfile
    container_name: wkf-analyzer-openai
    deploy:
      resources:
        limits:
          memory: 192M
    environment:
      # Database
      DB_HOST: wkf-postgres
      DB_PORT: ${DB_PORT}
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}

      # OpenAI
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      ANALYSIS_THRESHOLD_PERCENT: ${ANALYSIS_THRESHOLD_PERCENT}
      MAX_RECOMMENDATIONS_PER_ARTICLE: ${MAX_RECOMMENDATIONS_PER_ARTICLE}

      # KIS API
      KIS_APP_KEY: ${KIS_APP_KEY}
      KIS_APP_SECRET: ${KIS_APP_SECRET}
      KIS_ACCOUNT_NUMBER: ${KIS_ACCOUNT_NUMBER}
      KIS_BASE_URL: ${KIS_BASE_URL}
      KIS_IS_REAL_ACCOUNT: ${KIS_IS_REAL_ACCOUNT}

      # Market
      MARKET_OPEN_HOUR: ${MARKET_OPEN_HOUR}
      MARKET_OPEN_MINUTE: ${MARKET_OPEN_MINUTE}
      MARKET_CLOSE_HOUR: ${MARKET_CLOSE_HOUR}
      MARKET_CLOSE_MINUTE: ${MARKET_CLOSE_MINUTE}
      STOCK_HISTORY_DAYS: ${STOCK_HISTORY_DAYS}

      # Trading
      PROFIT_TARGET_PERCENT: ${PROFIT_TARGET_PERCENT}
      STOP_LOSS_PERCENT: ${STOP_LOSS_PERCENT}
      TRADE_MONITORING_INTERVAL_SECONDS: ${TRADE_MONITORING_INTERVAL_SECONDS}
      TRADE_AMOUNT_PER_STOCK: ${TRADE_AMOUNT_PER_STOCK}

      # Retry
      MAX_API_RETRIES: ${MAX_API_RETRIES}
      RETRY_BACKOFF_FACTOR: ${RETRY_BACKOFF_FACTOR}

      # Telegram
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN}
      TELEGRAM_CHAT_ID: ${TELEGRAM_CHAT_ID}

      # Logging
      LOG_LEVEL: ${LOG_LEVEL}
      LOG_FILE: logs/analyzer-openai.log
    volumes:
      - ./logs:/app/logs
    depends_on:
      wkf-postgres:
        condition: service_healthy
    networks:
      - wkf-network
    restart: always

  wkf-dashboard:
    build:
      context: ./dashboard
      dockerfile: Dockerfile
    container_name: wkf-dashboard
    deploy:
      resources:
        limits:
          memory: 128M
    environment:
      # Database
      DB_HOST: wkf-postgres
      DB_PORT: ${DB_PORT}
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}

      # Dashboard
      DASHBOARD_HOST: 0.0.0.0
      DASHBOARD_PORT: 8000
    ports:
      - "8000:8000"
    depends_on:
      wkf-postgres:
        condition: service_healthy
    networks:
      - wkf-network
    restart: always

networks:
  wkf-network:
    name: wkf-network
    driver: bridge
